generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Users & Authentication
// ============================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  emailPrefix   String    @unique  // alice@example.com â†’ alice, used for skill slugs
  passwordHash  String
  name          String?
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  skills        Skill[]
  teamMembers   TeamMember[]
  skillVersions SkillVersion[]
  feedback      SkillFeedback[]
  contributions TeamContribution[]

  // CLI API Tokens relation
  apiTokens     ApiToken[]

  @@map("users")
}

enum UserRole {
  USER
  TEAM_ADMIN
  ADMIN
}

// ============================================
// API Tokens (for CLI authentication)
// ============================================

model ApiToken {
  id          String        @id @default(uuid())
  userId      String
  name        String        // User-defined token name (e.g., "CI/CD", "Laptop")
  tokenHash   String        @unique  // SHA-256 hash of the token
  tokenPrefix String                 // First 8 chars for identification
  scopes      TokenScope[]           // Granular permissions
  lastUsedAt  DateTime?
  expiresAt   DateTime?              // Optional expiration
  createdAt   DateTime      @default(now())
  revokedAt   DateTime?              // For token revocation

  // Relations
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("api_tokens")
}

enum TokenScope {
  SKILL_READ        // Read skill info, download skills
  SKILL_WRITE       // Upload, update skills
  SKILL_DELETE      // Delete skills
  BUNDLE_READ       // Read bundles
  BUNDLE_WRITE      // Create, update bundles
  TEAM_READ         // Read team info
  ADMIN             // Full admin access
}

// ============================================
// Teams
// ============================================

model Team {
  id          String      @id @default(uuid())
  name        String
  slug        String      @unique
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  members       TeamMember[]
  skills        Skill[]
  bundles       SkillBundle[]
  contributions TeamContribution[]
  activities    TeamActivity[]

  @@map("teams")
}

model TeamMember {
  id       String       @id @default(uuid())
  teamId   String
  userId   String
  role     TeamRole     @default(MEMBER)
  joinedAt DateTime     @default(now())

  // Relations
  team     Team         @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user     User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@map("team_members")
}

enum TeamRole {
  MEMBER
  ADMIN
  OWNER
}

// ============================================
// Skills & Versions
// ============================================

model Skill {
  id          String        @id @default(uuid())
  name        String
  slug        String        // URL-friendly name (e.g., "pdf-reader")
  fullSlug    String        @unique  // GitHub-style: alice/pdf-reader
  description String?
  category    Category      @default(DEVELOPMENT)
  tags        String[]      @default([])
  authorId    String
  teamId      String?
  visibility  Visibility    @default(PUBLIC)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  author        User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  team          Team?         @relation(fields: [teamId], references: [id], onDelete: SetNull)
  versions      SkillVersion[]
  stats         SkillStat?
  bundleSkills  BundleSkill[]
  feedback      SkillFeedback[]
  downloads     DownloadRecord[]

  @@unique([slug, authorId])  // Keep for backward compatibility
  @@index([authorId])
  @@index([teamId])
  @@index([visibility])
  @@index([category])
  @@index([visibility, category])
  @@map("skills")
}

model SkillVersion {
  id                    String          @id @default(uuid())
  skillId               String
  version               String          // Semantic version (e.g., "1.0.0")
  changelog             String?
  filePath              String          // Path to stored zip file
  status                SkillStatus     @default(PENDING)
  specValidationPassed  Boolean?        @default(false)
  specValidationErrors  Json?
  aiSecurityAnalyzed    Boolean?        @default(false)
  aiSecurityReport      Json?
  processingComplete    Boolean?        @default(false)
  createdAt             DateTime        @default(now())
  createdBy             String

  // Relations
  skill       Skill           @relation(fields: [skillId], references: [id], onDelete: Cascade)
  creator     User            @relation(fields: [createdBy], references: [id])
  files       SkillFile[]
  evals       EvalQueue[]
  scans       SecurityScan[]

  @@unique([skillId, version])
  @@index([skillId])
  @@index([status])
  @@map("skill_versions")
}

enum SkillStatus {
  PENDING
  VALIDATING
  EVALUATING
  SCANNING
  APPROVED
  REJECTED
}

model SkillFile {
  id              String      @id @default(uuid())
  skillVersionId  String
  filePath        String      // Relative path within the skill
  fileType        String      // MIME type
  sizeBytes       Int
  content         String?     @db.Text // File content for text-based files (markdown, code, etc.)
  createdAt       DateTime    @default(now())

  // Relations
  skillVersion    SkillVersion @relation(fields: [skillVersionId], references: [id], onDelete: Cascade)

  @@index([skillVersionId])
  @@map("skill_files")
}

enum Visibility {
  PUBLIC
  TEAM_ONLY
  PRIVATE
}

enum Category {
  DEVELOPMENT
  SECURITY
  DATA_ANALYTICS
  AI_ML
  TESTING
  INTEGRATION
}

// ============================================
// Evaluation System
// ============================================

model EvalQueue {
  id              String      @id @default(uuid())
  skillVersionId  String
  status          JobStatus   @default(PENDING)
  priority        Int         @default(5)
  createdAt       DateTime    @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  error           String?

  // Relations
  skillVersion    SkillVersion @relation(fields: [skillVersionId], references: [id], onDelete: Cascade)
  results         EvalResult[]

  @@index([status])
  @@index([priority])
  @@map("eval_queues")
}

model EvalResult {
  id          String      @id @default(uuid())
  evalQueueId String
  testName    String
  status      TestStatus
  output      String?     @db.Text
  durationMs  Int
  createdAt   DateTime    @default(now())

  // Relations
  evalQueue   EvalQueue   @relation(fields: [evalQueueId], references: [id], onDelete: Cascade)

  @@index([evalQueueId])
  @@map("eval_results")
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum TestStatus {
  PASSED
  FAILED
  SKIPPED
  ERROR
}

// ============================================
// Security Scanner
// ============================================

model SecurityScan {
  id              String        @id @default(uuid())
  skillVersionId  String
  status          JobStatus     @default(PENDING)
  score           Int?          // 0-100
  riskLevel       String?       // low, medium, high, critical
  blockExecution  Boolean       @default(false)
  reportJson      Json?
  createdAt       DateTime      @default(now())
  completedAt     DateTime?

  // Relations
  skillVersion    SkillVersion  @relation(fields: [skillVersionId], references: [id], onDelete: Cascade)

  @@index([skillVersionId])
  @@index([riskLevel])
  @@map("security_scans")
}

// ============================================
// Security Configuration
// ============================================

model SecurityConfig {
  id                  String   @id @default(uuid())
  name                String   @unique
  version             String
  isActive            Boolean  @default(true)
  systemPrompt        String   @db.Text
  rulesJson           Json     // Array of SecurityRule
  outputFormat        String   @db.Text
  additionalSettings  Json?    // Any additional configuration
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("security_configs")
}

// ============================================
// Skill Bundles
// ============================================

model SkillBundle {
  id          String        @id @default(uuid())
  name        String
  slug        String        @unique
  description String?
  teamId      String?
  visibility  Visibility    @default(PUBLIC)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  team    Team?         @relation(fields: [teamId], references: [id], onDelete: SetNull)
  skills  BundleSkill[]
  stats   BundleStat?

  @@map("skill_bundles")
}

model BundleSkill {
  id        String      @id @default(uuid())
  bundleId  String
  skillId   String
  addedAt   DateTime    @default(now())

  // Relations
  bundle    SkillBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  skill     Skill       @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([bundleId, skillId])
  @@map("bundle_skills")
}

// ============================================
// Statistics
// ============================================

model SkillStat {
  id                String    @id @default(uuid())
  skillId           String    @unique
  downloadsCount    Int       @default(0)
  viewsCount        Int       @default(0)
  lastDownloadedAt  DateTime?
  lastViewedAt      DateTime?

  // Relations
  skill             Skill     @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@map("skill_stats")
}

// ============================================
// Audit Log
// ============================================

model AuditLog {
  id        String    @id @default(uuid())
  userId    String?
  action    String
  resource  String
  resourceId String?
  metadata  Json?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// Skill Feedback & Comments
// ============================================

model SkillFeedback {
  id        String    @id @default(uuid())
  skillId   String
  userId    String
  rating    Int?      // 1-5 stars, optional
  comment   String?   @db.Text
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  skill     Skill     @relation(fields: [skillId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([skillId])
  @@index([userId])
  @@index([createdAt])
  @@map("skill_feedback")
}

// ============================================
// Skill Specifications
// ============================================

model SkillSpecification {
  id          String   @id @default(uuid())
  version     String
  schema      Json
  description String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@map("skill_specifications")
}

// ============================================
// Team Contributions & Activities
// ============================================

model TeamContribution {
  id               String            @id @default(uuid())
  teamId           String
  userId           String
  contributionType ContributionType
  resourceId       String?
  points           Int               @default(1)
  createdAt        DateTime          @default(now())

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([userId])
  @@index([teamId, userId])
  @@map("team_contributions")
}

model TeamActivity {
  id          String   @id @default(uuid())
  teamId      String
  userId      String?
  action      String
  description String
  metadata    Json?
  createdAt   DateTime @default(now())

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([createdAt])
  @@map("team_activities")
}

// ============================================
// Download Tracking
// ============================================

model DownloadRecord {
  id            String        @id @default(uuid())
  skillId       String
  userId        String?
  version       String
  downloadType  DownloadType
  createdAt     DateTime      @default(now())

  // Relations
  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@index([skillId])
  @@index([userId])
  @@index([createdAt])
  @@map("download_records")
}

// ============================================
// Bundle Statistics
// ============================================

model BundleStat {
  id                String      @id @default(uuid())
  bundleId          String      @unique
  downloadsCount    Int         @default(0)
  viewsCount        Int         @default(0)
  lastDownloadedAt  DateTime?
  lastViewedAt      DateTime?

  // Relations
  bundle SkillBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  @@map("bundle_stats")
}

// ============================================
// Enums
// ============================================

enum ContributionType {
  SKILL_UPLOADED
  SKILL_DOWNLOADED
  EVAL_RUN
  SECURITY_SCAN
  BUNDLE_CREATED
  MEMBER_ADDED
}

enum DownloadType {
  FULL_ZIP
  SKILL_MD
  SCRIPTS_ZIP
  BUNDLE_ZIP
}
